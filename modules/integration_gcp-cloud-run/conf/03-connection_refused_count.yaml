module: GCP Cloud Run
name: CloudSQL connections refused to requests ratio

transformation: true
aggregation: ".count(by=['response_code_class'])"
value_unit: "%"

signals:
  A:
    metric: "infrastructure/cloudsql/connection_refused_count"
    filter: "filter('response_code_class', '5xx')"
  B:
    metric: "infrastructure/cloudsql/connection_request_count"
  signal:
    formula: (A/B).scale(100)

rules:
  critical:
    threshold: 5
    comparator: '>'
    lasting_duration: 1h
    lasting_at_least: 0.5
  major:
    threshold: 0
    comparator: '>'
    lasting_duration: 1h
    lasting_at_least: 0.5
    dependency: critical
