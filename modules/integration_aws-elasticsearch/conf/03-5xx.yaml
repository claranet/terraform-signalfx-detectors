module: AWS Elasticsearch
name: 5xx HTTP response
id: fivexx_http_response

aggregation: true
filtering: "filter('namespace', 'AWS/ES') and filter('stat', 'sum')"
tip: "In addition to the runbook, have a look at https://aws.amazon.com/premiumsupport/knowledge-center/opensearch-5xx-errors/"
runbook_url: "https://docs.aws.amazon.com/opensearch-service/latest/developerguide/managedomains-cloudwatchmetrics.html"
value_unit: "%"

signals:
  error_stream:
    metric: 5xx
  open_search_stream:
    metric: OpenSearchRequests
  elastic_search_stream:
    metric: ElasticsearchRequests
  open_search_signal:
    formula: (error_stream/open_search_stream*100)
    publish: true
  elastic_search_signal:
    formula: (error_stream/elastic_search_stream*100)
    publish: true

rules:
  critical_open_search:
    threshold: 10
    comparator: ">"
    lasting_duration: "5m"
    lasting_at_least: 0.9
    signal: open_search_signal
    severity: critical
  major_open_search:
    threshold: 5
    comparator: ">"
    dependency: critical_open_search
    lasting_duration: "5m"
    lasting_at_least: 0.9
    signal: open_search_signal
    severity: major
  critical_elastic_search:
    threshold: 10
    comparator: ">"
    lasting_duration: "5m"
    lasting_at_least: 0.9
    signal: elastic_search_signal
    severity: critical
  major_elastic_search:
    threshold: 5
    comparator: ">"
    dependency: critical_elastic_search
    lasting_duration: "5m"
    lasting_at_least: 0.9
    signal: elastic_search_signal
    severity: major
